pipeline {
    agent any
    stages {
        stage("Variables") {
            environment {
                GIT_COMMIT_MSG = sh(returnStdout: true, script: "git log -1 --pretty=%B").trim()
                GIT_TAG = sh(returnStdout: true, script: "git tag --contains").trim()
            }
            steps {
                sh "printenv"
            }
        }
        stage("npm install") {
            steps {
                sh "npm ci"
            }
        }
        stage("Lint commit") {
            steps {
                sh "npm run lint:commit"
            }
        }
        stage('Publish') {
            when {
                expression { env.GIT_TAG = null }
            }
            environment {
                NPM_TOKEN=credentials('NPM_TOKEN')
                GITHUB_TOKEN=credentials('GITHUB_TOKEN')
            }
            steps {
                withCredentials([gitUsernamePassword(credentialsId: 'github-credentials', gitToolName: 'Default')]) {
                    sh "npm run release"
                }
            }
        }
    }
}